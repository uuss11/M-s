<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>AR V8 - Dynamic Scaling</title>
    <style>
        :root { --neon: #ffcc00; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        #ui-layer {
            position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.85);
            color: white; padding: 20px; border-radius: 15px; border: 1px solid var(--neon);
            z-index: 100; pointer-events: none; width: 280px; box-shadow: 0 0 20px rgba(255, 204, 0, 0.3);
        }
        #ui-layer h3 { margin: 0 0 15px 0; color: var(--neon); text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px;}
        .gesture-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; }
        .instruction { color: #aaa; font-size: 0.85rem; margin-top: 5px; }

        #camPreview { position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: 1; opacity: 0.25; }
        canvas { position: fixed; inset: 0; z-index: 10; }
        
        #overlay { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; color: white; }
        button { padding: 20px 60px; border-radius: 50px; border: 3px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; font-size: 1.5rem; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--neon); color: black; box-shadow: 0 0 50px var(--neon); }
        
        #status-bar { position: fixed; bottom: 30px; width: 100%; text-align: center; color: var(--neon); z-index: 100; font-size: 1.2rem; text-shadow: 0 2px 5px #000; }
    </style>
</head>
<body>

<div id="ui-layer">
    <h3>ğŸ® Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù… V8</h3>
    <div class="gesture-item">
        <span>ğŸ¤ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù…:</span>
        <span>Ù‚Ø±Ø¨/Ø¨Ø¹Ø¯ Ø£ØµØ§Ø¨Ø¹Ùƒ</span>
    </div>
    <div class="instruction">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… ÙˆØ§Ù„Ø³Ø¨Ø§Ø¨Ø© ØªØ­Ø¯Ø¯ Ø­Ø¬Ù… Ø§Ù„Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
    <hr style="border-color: #333; margin: 15px 0;">
    <div class="gesture-item"><span>âœŒï¸ ØªÙØ¬ÙŠØ± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª</span></div>
    <div class="gesture-item"><span>âœŠ Ø¬Ø°Ø¨ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª</span></div>
</div>

<div id="overlay">
    <h1>AR ENGINE <span style="color:var(--neon)">V8</span></h1>
    <p style="opacity: 0.7; margin-bottom: 30px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Dynamic Scaling)</p>
    <button id="startButton">ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</button>
</div>

<div id="status-bar">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¨Ø¯Ø¡</div>
<video id="camPreview" playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

const videoEl = document.getElementById('camPreview');
const statusText = document.getElementById('status-bar');

// --- Ø¥Ø¹Ø¯Ø§Ø¯ Three.js ---
const scene = new THREE.Scene();
// ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø£ÙØ¶Ù„
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.z = 100; 

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Icosahedron - Ø´ÙƒÙ„ Ø¬ÙˆÙ‡Ø±Ø©)
const geometry = new THREE.IcosahedronGeometry(15, 1);
const material = new THREE.MeshNormalMaterial({ wireframe: true, transparent: true, opacity: 0.5 });
const mainMesh = new THREE.Mesh(geometry, material);
scene.add(mainMesh);

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ø§Ù„Ù…Ø­ÙŠØ·Ø©
const particleGeo = new THREE.BufferGeometry();
const particleCount = 1500;
const posArray = new Float32Array(particleCount * 3);
for(let i=0; i<particleCount*3; i++) posArray[i] = (Math.random()-0.5)*300;
particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
const particleMat = new THREE.PointsMaterial({ size: 1.5, color: 0xffcc00, blending: THREE.AdditiveBlending, transparent: true });
const particles = new THREE.Points(particleGeo, particleMat);
scene.add(particles);

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
let targetPos = new THREE.Vector3(0,0,0);
// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
let currentScale = 1;
let targetScale = 1;
let mode = "follow"; // follow, explode, attract

// --- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…Ø§Ø¡Ø§Øª ---
function analyzeGestures(hand) {
    const index = hand[8], middle = hand[12], ring = hand[16];
    // ÙƒØ´Ù Ø§Ù„Ù†ØµØ± âœŒï¸
    if (index.y < hand[6].y && middle.y < hand[10].y && ring.y > hand[14].y) return "PEACE";
    // ÙƒØ´Ù Ø§Ù„Ù‚Ø¨Ø¶Ø© âœŠ
    if (index.y > hand[6].y && middle.y > hand[10].y && ring.y > hand[14].y) return "FIST";
    return "follow";
}

// --- MediaPipe Holistic ---
const holistic = new window.Holistic({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`
});
holistic.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

holistic.onResults((res) => {
    if (res.rightHandLandmarks) {
        const hand = res.rightHandLandmarks;
        const thumbTip = hand[4];
        const indexTip = hand[8];

        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
        targetPos.x = -(hand[9].x - 0.5) * 200;
        targetPos.y = -(hand[9].y - 0.5) * 150;

        // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ØªØ­Ø¬ÙŠÙ… (The Core Logic)
        // Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ù‚Ù„ÙŠØ¯ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… ÙˆØ§Ù„Ø³Ø¨Ø§Ø¨Ø©
        const pinchDistance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„ ØªÙƒØ¨ÙŠØ± (Mapping)
        // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¹Ø§Ø¯Ø© ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0.02 (Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§) Ùˆ 0.2 (Ø¨Ø¹ÙŠØ¯)
        // Ù†Ø¶Ø±Ø¨ ÙÙŠ Ø±Ù‚Ù… (Ù…Ø«Ù„Ø§Ù‹ 12) ÙˆÙ†Ø¶ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨
        let newScale = (pinchDistance * 12); 
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬Ù… (Clamp)
        // Ù„Ù† ÙŠÙ‚Ù„ Ø§Ù„Ø­Ø¬Ù… Ø¹Ù† 0.4 ÙˆÙ„Ù† ÙŠØ²ÙŠØ¯ Ø¹Ù† 3.5
        targetScale = Math.max(0.4, Math.min(newScale, 3.5));

        // 3. ØªØ­Ø¯ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª (Ø§Ù†ÙØ¬Ø§Ø±/Ø¬Ø°Ø¨)
        mode = analyzeGestures(hand);
        if(mode === "PEACE") particleMat.color.set(0xff0055);
        else if(mode === "FIST") particleMat.color.set(0x00aaff);
        else particleMat.color.set(0xffcc00);

        statusText.innerText = `Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${(targetScale).toFixed(1)}x`;
    }
});

// --- Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ ---
function animate() {
    requestAnimationFrame(animate);
    
    // ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ø­Ø±ÙƒØ©
    mainMesh.position.lerp(targetPos, 0.1);
    
    // === ØªÙ†Ø¹ÙŠÙ… Ø§Ù„ØªØ­Ø¬ÙŠÙ… (Smooth Scaling) ===
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
    currentScale += (targetScale - currentScale) * 0.15;
    mainMesh.scale.set(currentScale, currentScale, currentScale);
    
    mainMesh.rotation.x += 0.005;
    mainMesh.rotation.y += 0.01;

    // Ø­Ø±ÙƒØ© Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª
    const positions = particleGeo.attributes.position.array;
    for (let i = 0; i < particleCount; i++) {
        const i3 = i * 3;
        const dx = mainMesh.position.x - positions[i3];
        const dy = mainMesh.position.y - positions[i3+1];
        const dz = mainMesh.position.z - positions[i3+2];
        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

        if (mode === "PEACE") { // Ø§Ù†ÙØ¬Ø§Ø±
            positions[i3] -= dx * 0.08; positions[i3+1] -= dy * 0.08; positions[i3+2] -= dz * 0.08;
        } else if (mode === "FIST") { // Ø¬Ø°Ø¨
            positions[i3] += dx * 0.08; positions[i3+1] += dy * 0.08; positions[i3+2] += dz * 0.08;
        } else { // ØªØªØ¨Ø¹ Ø¹Ø§Ø¯ÙŠ
            positions[i3] += (dx * 0.03) + Math.sin(i + Date.now()*0.001);
            positions[i3+1] += (dy * 0.03) + Math.cos(i + Date.now()*0.001);
            positions[i3+2] += (dz * 0.03);
        }
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©
        if (dist > 400 || dist < 5) {
             positions[i3] = mainMesh.position.x + (Math.random()-0.5)*200;
             positions[i3+1] = mainMesh.position.y + (Math.random()-0.5)*200;
             positions[i3+2] = mainMesh.position.z + (Math.random()-0.5)*200;
        }
    }
    particleGeo.attributes.position.needsUpdate = true;
    renderer.render(scene, camera);
}

// --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
document.getElementById('startButton').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    const cameraHelper = new window.Camera(videoEl, {
        onFrame: async () => { await holistic.send({ image: videoEl }); },
        width: 1280, height: 720
    });
    cameraHelper.start().then(() => {
        statusText.innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© ÙˆØ§Ù„Ø¥Ø¨Ù‡Ø§Ù… Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø¬Ù…";
        animate();
    });
};

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
