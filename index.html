<!DOCTYPE html><html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙŠØ¯ â€” Ù…ÙØ­Ø³Ù‘Ù†</title>
  <style>
    body{margin:0;overflow:hidden;background:#000;font-family:'Segoe UI',Tahoma,Arial}
    canvas{display:block}
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:12px}
    button{padding:12px 24px;border-radius:999px;border:none;background:#ff4757;color:#fff;cursor:pointer;font-size:1rem}
    #status{position:fixed;bottom:14px;left:0;right:0;text-align:center;color:#fff;z-index:10}
    #legend{position:fixed;top:12px;left:12px;padding:10px 12px;background:rgba(0,0,0,0.55);color:#fff;font-size:.88rem;line-height:1.6;border-radius:10px;z-index:30;backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,.45);max-width:240px}
    #legend b{display:block;margin-bottom:4px}
    #camBox{position:fixed;bottom:12px;right:12px;width:220px;height:160px;border-radius:12px;overflow:hidden;z-index:40;border:2px solid rgba(255,255,255,0.18);box-shadow:0 8px 30px rgba(0,0,0,.6);background:#000}
    #camBox video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  </style>
</head>
<body><div id="overlay">
  <h2 style="color:#fff;margin:0">ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙŠØ¯ â€” Ù…ÙØ­Ø³Ù‘Ù†</h2>
  <div style="color:#ddd">Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø«Ù… Ø³Ù…Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
  <button id="startButton">Ø§Ø¨Ø¯Ø£</button>
</div><div id="status">Ø¬Ø§Ù‡Ø²</div><div id="legend">
  <b>ğŸ® Ø­Ø±ÙƒØ§Øª Ø§Ù„ØªØ­ÙƒÙ…</b>
  ğŸ– ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø©: ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª
  <br>ğŸ¤ Ù‚Ø±ØµØ©: ØªÙƒØ¨ÙŠØ± / ØªØµØºÙŠØ±
  <br>âœŒï¸ Ø¥ØµØ¨Ø¹ÙŠÙ†: ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù†
  <br>ğŸ‘ Ø¥Ø¨Ù‡Ø§Ù… Ù„ÙÙˆÙƒ: ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ù…Ø¤Ù‚ØªØ§Ù‹
  <br>ğŸ¤˜ Ø±ÙˆÙƒ: ØªÙØ¬ÙŠØ± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª
  <br>ğŸ– ÙŠØ¯ Ù…ÙØªÙˆØ­Ø©: ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ù…Ø´Ù‡Ø¯
  <br>ğŸ‘‹ ØªÙ„ÙˆÙŠØ­: Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯
</div><div id="camBox"><video id="camPreview" autoplay muted playsinline></video></div><script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script><script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script><script type="module">
  import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const startButton = document.getElementById('startButton');
  const overlay = document.getElementById('overlay');
  const statusText = document.getElementById('status');
  const camPreview = document.getElementById('camPreview');

  // ThreeJS
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);
  camera.position.z = 85;

  // Ø¬Ø²ÙŠØ¦Ø§Øª
  const COUNT = 2000;
  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(COUNT*3);
  const col = new Float32Array(COUNT*3);

  for(let i=0;i<COUNT;i++){
    pos[i*3]=(Math.random()-.5)*120;
    pos[i*3+1]=(Math.random()-.5)*120;
    pos[i*3+2]=(Math.random()-.5)*120;
    col[i*3]=0.6; col[i*3+1]=0.6; col[i*3+2]=1;
  }
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  geo.setAttribute('color', new THREE.BufferAttribute(col,3));

  const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
  const mat = new THREE.PointsMaterial({size:0.9,vertexColors:true,transparent:true,blending:THREE.AdditiveBlending,map:sprite,depthWrite:false});
  const particles = new THREE.Points(geo,mat);
  scene.add(particles);

  // Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù‡Ø¯Ù
  const heart=(t)=> new THREE.Vector3(16*Math.pow(Math.sin(t),3),13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t),0);
  const sphere=(i)=>{ const phi=Math.acos(-1+2*i/COUNT); const th=Math.sqrt(COUNT*Math.PI)*phi; return new THREE.Vector3().setFromSphericalCoords(22,phi,th); };

  // Mediapipe setup
  let handX=0, handY=0, scale=1, rotSpeed=0.002, freeze=false;
  let colorMode=0;
  let currentShape='sphere';

  // ÙÙŠØ¯ÙŠÙˆ Ù…Ø®ÙÙŠ Ù„Ù€ Mediapipe
  const video = document.createElement('video');
  video.autoplay=true; video.muted=true; video.playsInline=true; video.style.display='none';
  document.body.appendChild(video);

  const hands = new Hands({ locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
  hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.55, minTrackingConfidence:0.55 });

  // Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø±: cooldowns
  let lastColorTime=0, lastExplosionTime=0, lastBoostTime=0, lastResetTime=0;
  const COOLDOWN = 700; // Ù…Ù„Ù‘ÙŠ Ø«Ø§Ù†ÙŠØ©

  // Ù„ØªØªØ¨Ø¹ Ù…ÙˆØ¬Ø© Ø§Ù„ÙŠØ¯
  const waveHistory = [];

  hands.onResults((results)=>{
    // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø©
    const now = performance.now();
    if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
      const lm = results.multiHandLandmarks[0];

      // Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø¨Ø§Ø¨Ø© ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø´Ù‡Ø¯
      handX = (lm[8].x - 0.5) * window.innerWidth * 0.06;
      handY = -(lm[8].y - 0.5) * window.innerHeight * 0.045;

      // Ù‚ÙŠØ§Ø³ Ø§Ù„Ù‚Ø±ØµØ©: Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… (4) ÙˆØ³Ø¨Ø§Ø¨Ø© (8)
      const dx = lm[4].x - lm[8].x;
      const dy = lm[4].y - lm[8].y;
      scale = Math.max(0.55, Math.sqrt(dx*dx + dy*dy) * 8);

      // Ù‚Ø¨Ø¶Ø© Ø¨Ø³ÙŠØ· (Ù‚Ù„Ø¨)
      const isFist = (lm[12].y > lm[9].y);
      currentShape = isFist ? 'heart' : 'sphere';

      // âœŒï¸ V sign detection (index & middle up, ring down or neutral)
      const indexUp = lm[8].y < lm[6].y;
      const middleUp = lm[12].y < lm[10].y;
      const ringUp = lm[16].y < lm[14].y;
      if(indexUp && middleUp && !ringUp && (now - lastColorTime > COOLDOWN)){
        colorMode = (colorMode + 1) % 3;
        lastColorTime = now;
        statusText.innerText = 'ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ÙˆÙ†';
      }

      // ğŸ‘ thumb up (Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… Ù…Ø±ÙÙˆØ¹ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù…ÙØ§ØµÙ„ Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù…)
      const thumbUp = lm[4].y < lm[3].y;
      if(thumbUp && (now - lastBoostTime > 800)){
        lastBoostTime = now;
        rotSpeed = 0.015; // Ø¯ÙØ¹Ø©
        setTimeout(()=>{ rotSpeed = 0.002; }, 500);
        statusText.innerText = 'Ø²ÙŠØ§Ø¯Ø© Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†';
      }

      // ğŸ¤˜ rock-like: index up & pinky up & middle/ ring down (Ù…Ù‚Ø§Ø±Ø¨Ø© Ø¨Ø³ÙŠØ·Ø©)
      const pinkyUp = lm[20].y < lm[18].y;
      const rock = indexUp && pinkyUp && (lm[12].y > lm[10].y) && (now - lastExplosionTime > 1000);
      if(rock){
        lastExplosionTime = now;
        // ØªÙØ¬ÙŠØ±: Ø¯ÙØ¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ù„Ù„Ø®Ø§Ø±Ø¬
        for(let i=0;i<COUNT;i++){
          pos[i*3] += (Math.random()-.5) * 60;
          pos[i*3+1] += (Math.random()-.5) * 60;
          pos[i*3+2] += (Math.random()-.5) * 60;
        }
        statusText.innerText = 'ØªÙØ¬ÙŠØ± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª!';
      }

      // ğŸ– ÙŠØ¯ Ù…ÙØªÙˆØ­Ø© ØªÙ…Ø§Ù…Ø§Ù‹ -> ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ©
      const openHand = indexUp && middleUp && ringUp && pinkyUp;
      freeze = openHand;
      if(freeze) statusText.innerText = 'ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø±ÙƒØ©';

      // ğŸ‘‹ Ù…ÙˆØ¬Ø©: Ù†Ø­ØªÙØ¸ Ø¨Ù…Ø®Ø²Ù† x ÙˆÙ†ÙØ­Øµ Ø§ØªØ³Ø§Ø¹ Ø§Ù„Ø­Ø±ÙƒØ©
      waveHistory.push(lm[8].x);
      if(waveHistory.length > 8) waveHistory.shift();
      const minX = Math.min(...waveHistory);
      const maxX = Math.max(...waveHistory);
      if(maxX - minX > 0.38 && (now - lastResetTime > 800)){
        lastResetTime = now;
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·: Ù†Ø¹ÙŠØ¯ ØªÙˆØ²ÙŠØ¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        for(let i=0;i<COUNT;i++){
          pos[i*3] = (Math.random()-.5) * 120;
          pos[i*3+1] = (Math.random()-.5) * 120;
          pos[i*3+2] = (Math.random()-.5) * 120;
        }
        statusText.innerText = 'Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø´Ù‡Ø¯';
      }

    } else {
      statusText.innerText = 'Ù„Ù… ØªÙÙƒØªØ´Ù ÙŠØ¯ â€” Ù‚Ø±Ø¨ ÙŠØ¯Ùƒ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ waveHistory Ù†Ø¸ÙŠÙ Ù„Ùˆ Ù…Ø§ÙÙŠÙ‡ ÙŠØ¯
      waveHistory.length = 0;
    }
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ + Mediapipe Camera
  startButton.onclick = async ()=>{
    overlay.style.display = 'none';
    statusText.innerText = 'Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
    try{
      const cameraHelper = new Camera(video, {
        onFrame: async ()=>{ await hands.send({image: video}); },
        width: 640, height: 480
      });
      await cameraHelper.start();

      // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù†Ø±Ø¨Ø· Ø§Ù„Ù€ preview Ø¨Ù…ØµØ¯Ø± Ù†ÙØ³ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (video.srcObject ÙŠØµØ¨Ø­ Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ start)
      try{ camPreview.srcObject = video.srcObject; await camPreview.play(); }catch(e){ /* Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù‚Ø¯ ØªÙ…Ù†Ø¹ play Ø¢Ù„ÙŠÙ‹Ø§ */ }

      statusText.innerText = 'ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø© â€” Ù‚Ø±Ø¨ ÙŠØ¯Ùƒ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      animate();
    }catch(err){
      console.error('Camera error',err);
      statusText.innerText = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + (err && err.message?err.message:err);
      overlay.style.display = 'flex';
    }
  };

  // Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  let time = 0;
  function animate(){
    requestAnimationFrame(animate);
    if(!freeze) time += 0.012;

    const positions = geo.attributes.position.array;
    const colors = geo.attributes.color.array;

    for(let i=0;i<COUNT;i++){
      const i3 = i*3;
      // Ù‡Ø¯Ù Ø­Ø³Ø¨ Ø§Ù„Ø´ÙƒÙ„
      let target = (currentShape==='heart') ? heart((i/COUNT)*Math.PI*2).multiplyScalar(scale*1.6) : sphere(i).multiplyScalar(scale*1.2);
      const noise = Math.sin(time + i) * 0.6;

      positions[i3] += (target.x + handX + noise - positions[i3]) * 0.11;
      positions[i3+1] += (target.y + handY + noise - positions[i3+1]) * 0.11;
      positions[i3+2] += (target.z - positions[i3+2]) * 0.095;

      // Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹
      if(colorMode===0){ colors[i3]=0.6; colors[i3+1]=0.6; colors[i3+2]=1; }
      else if(colorMode===1){ colors[i3]=1; colors[i3+1]=0.45; colors[i3+2]=0.5; }
      else { colors[i3]=0.35; colors[i3+1]=0.95; colors[i3+2]=0.6; }
    }

    geo.attributes.position.needsUpdate = true;
    geo.attributes.color.needsUpdate = true;

    particles.rotation.y += rotSpeed;
    renderer.render(scene,camera);
  }

  window.addEventListener('resize',()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });

</script></body>
</html>
