<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>AR Gesture Pro - V6.5</title>
    <style>
        :root { --neon: #00ffcc; --bg: #000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        #ui-layer {
            position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.85);
            color: white; padding: 20px; border-radius: 15px; border: 1px solid var(--neon);
            z-index: 100; pointer-events: none; width: 280px; box-shadow: 0 0 20px rgba(0,255,204,0.2);
        }
        #ui-layer h3 { margin: 0 0 10px 0; color: var(--neon); text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .gesture-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .active-status { color: #ff0055; font-weight: bold; animation: blink 1s infinite; }

        #camPreview { position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: 1; opacity: 0.2; }
        canvas { position: fixed; inset: 0; z-index: 10; }
        
        #overlay { position: fixed; inset: 0; background: radial-gradient(circle, #111 0%, #000 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; color: white; }
        button { padding: 20px 70px; border-radius: 50px; border: 2px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; font-size: 1.5rem; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--neon); color: black; box-shadow: 0 0 40px var(--neon); }
        
        #status-bar { position: fixed; bottom: 30px; width: 100%; text-align: center; color: var(--neon); z-index: 100; font-size: 1.2rem; text-shadow: 0 0 10px #000; }
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div id="ui-layer">
    <h3>ğŸ® Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
    <div class="gesture-item"><span>Ù†Ø«Ø± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª:</span> <span>Ø³ÙˆÙŠ âœŒï¸</span></div>
    <div class="gesture-item"><span>Ø³Ø­Ø¨ Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ:</span> <span>Ø³ÙˆÙŠ âœŠ</span></div>
    <div class="gesture-item"><span>ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„:</span> <span>Ù‚Ù„ "ØªØ¨Ø¯ÙŠÙ„"</span></div>
    <hr style="border:0; border-top:1px solid #333">
    <div id="current-gesture" class="active-status">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙŠØ¯...</div>
</div>

<div id="overlay">
    <h1 style="letter-spacing: 8px; margin-bottom: 5px;">GESTURE <span style="color:var(--neon)">V6</span></h1>
    <p style="opacity: 0.6; margin-bottom: 40px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø­Ø±ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</p>
    <button id="startButton">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ</button>
</div>

<div id="status-bar">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
<video id="camPreview" playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

const videoEl = document.getElementById('camPreview');
const statusText = document.getElementById('status-bar');
const gestureText = document.getElementById('current-gesture');

// --- Ø¥Ø¹Ø¯Ø§Ø¯ Three.js ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
camera.position.z = 120;

// Ø£Ø´ÙƒØ§Ù„ Ù‡Ù†Ø¯Ø³ÙŠØ© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„
const geometries = [
    new THREE.TorusKnotGeometry(15, 5, 150, 20),
    new THREE.SphereGeometry(20, 32, 32),
    new THREE.BoxGeometry(25, 25, 25)
];
let currentGeoIndex = 0;
const mainMesh = new THREE.Mesh(geometries[0], new THREE.MeshBasicMaterial({ color: 0x00ffcc, wireframe: true, transparent: true, opacity: 0.15 }));
scene.add(mainMesh);

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª
const COUNT = 3000;
const posArr = new Float32Array(COUNT * 3);
const velArr = new Float32Array(COUNT * 3); // Ù„Ù„Ø³Ø±Ø¹Ø©
const geo = new THREE.BufferGeometry();
for(let i=0; i<COUNT*3; i++) posArr[i] = (Math.random()-0.5)*300;
geo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
const mat = new THREE.PointsMaterial({ size: 1.0, color: 0x00ffcc, blending: THREE.AdditiveBlending, transparent: true });
const particles = new THREE.Points(geo, mat);
scene.add(particles);

let targetPos = new THREE.Vector3(0,0,0);
let mode = "follow"; // follow, explode, attract

// --- Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙŠØ¯ ---
function getGesture(hand) {
    const tip8 = hand[8].y, tip12 = hand[12].y, tip16 = hand[16].y, tip20 = hand[20].y;
    const mid8 = hand[7].y, mid12 = hand[11].y;

    // Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†ØµØ± (Ø¥ØµØ¨Ø¹ÙŠÙ† Ù…Ø±ÙÙˆØ¹ÙŠÙ† ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù†Ø§Ø²Ù„)
    if (tip8 < mid8 && tip12 < mid12 && tip16 > hand[14].y && tip20 > hand[18].y) return "PEACE";
    // Ù‚Ø¨Ø¶Ø© Ø§Ù„ÙŠØ¯ (ÙƒÙ„ Ø§Ù„Ø£ØµØ§Ø¨Ø¹ ØªØ­Øª Ù…ÙØ§ØµÙ„Ù‡Ø§)
    if (tip8 > mid8 && tip12 > mid12 && tip16 > hand[15].y) return "FIST";
    
    return "OPEN";
}

// --- MediaPipe Holistic ---
const holistic = new window.Holistic({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`
});
holistic.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

holistic.onResults((res) => {
    if (res.rightHandLandmarks) {
        const hand = res.rightHandLandmarks;
        targetPos.x = -(hand[9].x - 0.5) * 200;
        targetPos.y = -(hand[9].y - 0.5) * 150;

        const gesture = getGesture(hand);
        if (gesture === "PEACE") {
            mode = "explode";
            gestureText.innerText = "ÙˆØ¶Ø¹ Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± âœŒï¸";
            mat.color.set(0xff0055);
        } else if (gesture === "FIST") {
            mode = "attract";
            gestureText.innerText = "Ø«Ù‚Ø¨ Ø£Ø³ÙˆØ¯ âœŠ";
            mat.color.set(0xaa00ff);
        } else {
            mode = "follow";
            gestureText.innerText = "ØªØªØ¨Ø¹ Ù†Ø§Ø¹Ù… ğŸ–ï¸";
            mat.color.set(0x00ffcc);
        }
    } else {
        mode = "idle";
        gestureText.innerText = "Ø£Ø¸Ù‡Ø± ÙŠØ¯Ùƒ Ø§Ù„ÙŠÙ…Ù†Ù‰...";
    }
});

// --- Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙˆØªÙŠØ© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ---
const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
if(Speech) {
    const rec = new Speech();
    rec.continuous = true;
    rec.lang = 'ar-SA';
    rec.onresult = (e) => {
        const cmd = e.results[e.results.length-1][0].transcript;
        if(cmd.includes("ØªØ¨Ø¯ÙŠÙ„") || cmd.includes("Ø´ÙƒÙ„")) {
            currentGeoIndex = (currentGeoIndex + 1) % geometries.length;
            mainMesh.geometry = geometries[currentGeoIndex];
            statusText.innerText = "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´ÙƒÙ„ Ù‡Ù†Ø¯Ø³ÙŠØ§Ù‹";
        }
    };
    rec.start();
}

// --- Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Physics Loop) ---
function animate() {
    requestAnimationFrame(animate);
    
    mainMesh.rotation.y += 0.01;
    mainMesh.position.lerp(targetPos, 0.05);

    const positions = geo.attributes.position.array;

    for (let i = 0; i < COUNT; i++) {
        const i3 = i * 3;
        const x = positions[i3], y = positions[i3+1], z = positions[i3+2];
        
        const dx = targetPos.x - x;
        const dy = targetPos.y - y;
        const dz = targetPos.z - z;
        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);

        if (mode === "explode") {
            // ØªØ·Ø´Ø± Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„ÙŠØ¯
            positions[i3] -= dx/dist * 5;
            positions[i3+1] -= dy/dist * 5;
            positions[i3+2] -= dz/dist * 5;
        } else if (mode === "attract") {
            // Ø³Ø­Ø¨ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ù„Ù…Ø±ÙƒØ² Ø§Ù„ÙŠØ¯
            positions[i3] += dx * 0.05;
            positions[i3+1] += dy * 0.05;
            positions[i3+2] += dz * 0.05;
        } else {
            // Ø­Ø±ÙƒØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„ÙŠØ¯
            positions[i3] += (dx * 0.02) + (Math.random()-0.5)*2;
            positions[i3+1] += (dy * 0.02) + (Math.random()-0.5)*2;
            positions[i3+2] += (dz * 0.02) + (Math.random()-0.5)*2;
        }

        // Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ù„Ù„Ø£Ø¨Ø¯
        if (Math.abs(positions[i3]) > 300) positions[i3] = (Math.random()-0.5)*200;
    }
    
    geo.attributes.position.needsUpdate = true;
    renderer.render(scene, camera);
}

// --- Ø§Ù„ØªØ´ØºÙŠÙ„ ---
document.getElementById('startButton').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    const cameraHelper = new window.Camera(videoEl, {
        onFrame: async () => { await holistic.send({ image: videoEl }); },
        width: 1280, height: 720
    });
    cameraHelper.start().then(() => {
        statusText.innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… Ù†Ø´Ø· - Ø¬Ø±Ø¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¨ÙŠØ¯Ùƒ Ø§Ù„ÙŠÙ…Ù†Ù‰";
        animate();
    });
};

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>

