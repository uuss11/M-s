<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AR Ø§Ù„Ø¬Ø³Ù… ÙˆØ§Ù„ÙŠØ¯ - Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ©</title>
<style>
  body { margin: 0; overflow: hidden; background: #000; }
  #camPreview { position: fixed; inset: 0; width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); z-index: 1; }
  canvas { position: fixed; inset: 0; z-index: 10; pointer-events: none; }
  #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; color: white; text-align: center; }
  button { padding: 15px 40px; border-radius: 50px; border: none; background: #00d1b2; color: white; cursor: pointer; font-size: 1.2rem; box-shadow: 0 0 15px #00d1b2; }
  #status { position: fixed; top: 10px; width: 100%; text-align: center; color: #00ff88; z-index: 100; font-weight: bold; text-shadow: 0 0 10px #000; }
</style>
</head>
<body>

<div id="overlay">
  <h1>Ù…Ø­Ø±Ùƒ AR Ø§Ù„Ø°ÙƒÙŠ V5</h1>
  <p>ØªØªØ¨Ø¹ Ø°ÙƒÙŠ (ÙŠØ¯ØŒ Ø¬Ø³Ù…ØŒ Ø£Ùˆ ÙƒÙ„ÙŠÙ‡Ù…Ø§) + Ø£ÙˆØ§Ù…Ø± ØµÙˆØªÙŠØ©</p>
  <button id="startButton">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
</div>

<div id="status">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±ØµØ¯ Ø§Ù„Ø­Ø±ÙƒØ©...</div>
<video id="camPreview" playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';

const startButton = document.getElementById('startButton');
const overlay = document.getElementById('overlay');
const statusText = document.getElementById('status');
const videoEl = document.getElementById('camPreview');

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ù‡Ø¯
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);
camera.position.z = 75;

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª
const COUNT = 1800;
const posArr = new Float32Array(COUNT * 3);
const colArr = new Float32Array(COUNT * 3);
for(let i=0; i<COUNT*3; i++) posArr[i] = (Math.random()-0.5)*150;

const geo = new THREE.BufferGeometry();
geo.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
geo.setAttribute('color', new THREE.BufferAttribute(colArr, 3));
const mat = new THREE.PointsMaterial({ size: 1.0, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
const particles = new THREE.Points(geo, mat);
scene.add(particles);

// Ø®ÙŠÙˆØ· Ø§Ù„Ø¬Ø³Ù… ÙˆØ§Ù„ÙŠØ¯ÙŠÙ† (Ø§Ø³ØªØ®Ø¯Ø§Ù… LineSegments Ù„Ù„Ø³Ø±Ø¹Ø©)
const lineGeo = new THREE.BufferGeometry();
const lineMat = new THREE.LineBasicMaterial({ color: 0x00ffcc, transparent: true, opacity: 0.7 });
const allLines = new THREE.LineSegments(lineGeo, lineMat);
scene.add(allLines);

let targetPos = new THREE.Vector3(0,0,0);
let scaleVal = 1;
let pColor = new THREE.Color(0x00ffff);

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡)
function to3D(lm) {
    if(!lm) return null;
    return new THREE.Vector3(-(lm.x - 0.5) * 110, -(lm.y - 0.5) * 80, -lm.z * 50);
}

const holistic = new Holistic({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}` });
holistic.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.4, minTrackingConfidence: 0.4 });

holistic.onResults((res) => {
    const points = [];
    
    // 1. ØªØªØ¨Ø¹ Ø§Ù„Ø¬Ø³Ù… (Pose) - Ø­ØªÙ‰ Ù„Ùˆ Ù†ØµÙ Ø¬Ø³Ù…
    if (res.poseLandmarks) {
        const poseConn = [[11,12], [11,13], [13,15], [12,14], [14,16], [11,23], [12,24], [23,24]];
        poseConn.forEach(([a, b]) => {
            const p1 = to3D(res.poseLandmarks[a]);
            const p2 = to3D(res.poseLandmarks[b]);
            if(p1 && p2) points.push(p1, p2);
        });
        scaleVal = Math.max(0.5, Math.abs(res.poseLandmarks[11].x - res.poseLandmarks[12].x) * 6);
    }

    // 2. ØªØªØ¨Ø¹ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø­ØªÙ‰ Ù„Ùˆ Ø¸Ù‡Ø±Øª ÙˆØ­Ø¯Ù‡Ø§)
    if (res.rightHandLandmarks) {
        const hand = res.rightHandLandmarks;
        const handConn = [[0,1],[1,2],[2,3],[3,4], [0,5],[5,6],[6,7],[7,8], [9,10],[10,11],[11,12], [13,14],[14,15],[15,16], [17,18],[18,19],[19,20], [0,17], [5,9], [9,13], [13,17]];
        handConn.forEach(([a, b]) => {
            const p1 = to3D(hand[a]);
            const p2 = to3D(hand[b]);
            if(p1 && p2) points.push(p1, p2);
        });
        
        // Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨ ğŸ¤ ÙˆØ§Ù„ØªØ­ÙƒÙ…
        targetPos.lerp(to3D(hand[8]), 0.3);
        const dist = Math.hypot(hand[8].x - hand[4].x, hand[8].y - hand[4].y);
        if(dist < 0.06) {
            statusText.innerText = "ØªØ­ÙƒÙ… Ù†Ø´Ø·: ØªÙ… Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ Ø¨Ø§Ù„Ø´ÙƒÙ„ ğŸ¤";
            pColor.set(0xffaa00);
        } else {
            pColor.set(0x00ffff);
            statusText.innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØµØºÙŠ... Ø­Ø±Ùƒ ÙŠØ¯Ùƒ Ø£Ùˆ Ø¬Ø³Ù…Ùƒ";
        }
    }

    // 3. ØªØªØ¨Ø¹ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰
    if (res.leftHandLandmarks) {
        const hand = res.leftHandLandmarks;
        const handConn = [[0,1],[1,2],[2,3],[3,4], [0,5],[5,6],[6,7],[7,8], [17,18],[18,19],[19,20], [0,17]];
        handConn.forEach(([a, b]) => {
            const p1 = to3D(hand[a]);
            const p2 = to3D(hand[b]);
            if(p1 && p2) points.push(p1, p2);
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·ÙˆØ· ÙÙˆØ±Ø§Ù‹
    if(points.length > 0) {
        lineGeo.setFromPoints(points);
        allLines.visible = true;
    } else {
        allLines.visible = false;
    }
});

// Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØµÙˆØªÙŠ
const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
if(Speech) {
    const rec = new Speech();
    rec.continuous = true;
    rec.lang = 'ar-SA';
    rec.onresult = (e) => {
        const cmd = e.results[e.results.length-1][0].transcript.trim();
        if(cmd.includes("Ø£Ø­Ù…Ø±")) pColor.set(0xff0000);
        if(cmd.includes("Ø£Ø®Ø¶Ø±")) pColor.set(0x00ff00);
        if(cmd.includes("Ø£Ø²Ø±Ù‚")) pColor.set(0x00ffff);
    };
    rec.start();
}

function animate() {
    requestAnimationFrame(animate);
    const pos = geo.attributes.position;
    const col = geo.attributes.color;

    for (let i = 0; i < COUNT; i++) {
        const phi = Math.acos(-1 + 2*i/COUNT);
        const th = Math.sqrt(COUNT*Math.PI)*phi;
        const tx = Math.cos(th)*Math.sin(phi) * 18 * scaleVal + targetPos.x;
        const ty = Math.sin(th)*Math.sin(phi) * 18 * scaleVal + targetPos.y;
        const tz = Math.cos(phi) * 18 * scaleVal + targetPos.z;

        posArr[i*3] += (tx - posArr[i*3]) * 0.12;
        posArr[i*3+1] += (ty - posArr[i*3+1]) * 0.12;
        posArr[i*3+2] += (tz - posArr[i*3+2]) * 0.12;

        col.setXYZ(i, pColor.r, pColor.g, pColor.b);
    }
    pos.needsUpdate = true;
    col.needsUpdate = true;
    renderer.render(scene, camera);
}

startButton.onclick = () => {
    overlay.style.display = 'none';
    new Camera(videoEl, {
        onFrame: async () => { await holistic.send({ image: videoEl }); },
        width: 1280, height: 720
    }).start();
    animate();
};
</script>
</body>
</html>
